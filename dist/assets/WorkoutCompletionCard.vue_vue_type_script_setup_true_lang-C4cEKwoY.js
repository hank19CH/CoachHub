import{s as p,d as E,u as I,m as T,o as g,c as k,a,f as C,t as f,w as X,v as O,b as v,g as Y,r as D,y as z,h as H,i as W,z as j,q as w,j as V}from"./index-CR_8Ibs2.js";import{t as b,c as B,n as q,e as L,g as F,m as $,a as y,b as R}from"./format-HA5A4YDt.js";async function We(e,o){const{data:t,error:i}=await p.from("coach_athletes").select("athlete_id").eq("coach_id",e).eq("status","active");if(i)throw i;if(!t||t.length===0)return[];const s=o?.athleteId?[o.athleteId]:t.map(m=>m.athlete_id);let r=p.from("workout_completions").select(`
      *,
      athlete:profiles!workout_completions_athlete_id_fkey(
        id,
        display_name,
        avatar_url,
        username
      ),
      assignment:workout_assignments!workout_completions_assignment_id_fkey(
        *,
        workout:workouts(
          name,
          description
        )
      ),
      exercise_results(
        *,
        exercise:exercises(name)
      )
    `).in("athlete_id",s).order("completed_at",{ascending:!1});o?.startDate&&(r=r.gte("completed_at",o.startDate)),o?.endDate&&(r=r.lte("completed_at",o.endDate)),o?.limit&&(r=r.limit(o.limit));const{data:c,error:n}=await r;if(n)throw n;return c||[]}async function je(e,o,t=30){const{data:i}=await p.from("coach_athletes").select("id").eq("coach_id",o).eq("athlete_id",e).eq("status","active").single();if(!i)throw new Error("No active coach-athlete relationship");const{data:s,error:r}=await p.from("workout_completions").select(`
      *,
      athlete:profiles!workout_completions_athlete_id_fkey(
        id,
        display_name,
        avatar_url,
        username
      ),
      assignment:workout_assignments!workout_completions_assignment_id_fkey(
        *,
        workout:workouts(*)
      ),
      exercise_results(
        *,
        exercise:exercises(*)
      )
    `).eq("athlete_id",e).order("completed_at",{ascending:!1}).limit(t);if(r)throw r;return s||[]}async function Ve(e,o,t){const{data:i,error:s}=await p.from("workout_assignments").select("id, status, assigned_date").eq("athlete_id",e).eq("coach_id",o).gte("assigned_date",t.start).lte("assigned_date",t.end).order("assigned_date",{ascending:!0});if(s)throw s;const r=i?.length||0,c=i?.filter(d=>d.status==="completed").length||0,n=r>0?c/r*100:0;let m=0;if(i&&i.length>0){const d=[...i].reverse();for(const h of d)if(h.status==="completed")m++;else break}return{totalAssigned:r,totalCompleted:c,complianceRate:Math.round(n),currentStreak:m,missedWorkouts:r-c}}async function U(e,o,t){const{data:i,error:s}=await p.from("workout_completions").select("athlete_id").eq("id",e).single();if(s)throw s;const{data:r}=await p.from("coach_athletes").select("id").eq("coach_id",t).eq("athlete_id",i.athlete_id).eq("status","active").single();if(!r)throw new Error("Unauthorized to provide feedback on this workout");const{data:c,error:n}=await p.from("workout_completions").update({coach_feedback:o,feedback_at:new Date().toISOString()}).eq("id",e).select().single();if(n)throw n;return c}async function Be(e,o,t=12){const{data:i}=await p.from("coach_athletes").select("id").eq("coach_id",o).eq("athlete_id",e).eq("status","active").single();if(!i)throw new Error("No active coach-athlete relationship");const s=new Date;s.setDate(s.getDate()-t*7);const{data:r,error:c}=await p.from("workout_completions").select(`
      completed_at,
      duration_minutes,
      overall_rpe,
      has_pb,
      exercise_results(
        sets_completed,
        reps_completed,
        weight_used_kg,
        distance_meters,
        is_pb
      )
    `).eq("athlete_id",e).gte("completed_at",s.toISOString()).order("completed_at",{ascending:!0});if(c)throw c;return r||[]}function M(e,o){const t=+b(e)-+b(o);return t<0?-1:t>0?1:t}function P(e){return B(e,Date.now())}function G(e,o,t){const[i,s]=q(t?.in,e,o),r=i.getFullYear()-s.getFullYear(),c=i.getMonth()-s.getMonth();return r*12+c}function J(e){return o=>{const i=(e?Math[e]:Math.trunc)(o);return i===0?0:i}}function K(e,o){return+b(e)-+b(o)}function Q(e,o){const t=b(e,o?.in);return t.setHours(23,59,59,999),t}function Z(e,o){const t=b(e,o?.in),i=t.getMonth();return t.setFullYear(t.getFullYear(),i+1,0),t.setHours(23,59,59,999),t}function ee(e,o){const t=b(e,o?.in);return+Q(t,o)==+Z(t,o)}function te(e,o,t){const[i,s,r]=q(t?.in,e,e,o),c=M(s,r),n=Math.abs(G(s,r));if(n<1)return 0;s.getMonth()===1&&s.getDate()>27&&s.setDate(30),s.setMonth(s.getMonth()-c*n);let m=M(s,r)===-c;ee(i)&&n===1&&M(i,r)===1&&(m=!1);const d=c*(n-+m);return d===0?0:d}function se(e,o,t){const i=K(e,o)/1e3;return J(t?.roundingMethod)(i)}function oe(e,o,t){const i=R(),s=t?.locale??i.locale??L,r=2520,c=M(e,o);if(isNaN(c))throw new RangeError("Invalid time value");const n=Object.assign({},t,{addSuffix:t?.addSuffix,comparison:c}),[m,d]=q(t?.in,...c>0?[o,e]:[e,o]),h=se(d,m),u=(F(d)-F(m))/1e3,l=Math.round((h-u)/60);let x;if(l<2)return t?.includeSeconds?h<5?s.formatDistance("lessThanXSeconds",5,n):h<10?s.formatDistance("lessThanXSeconds",10,n):h<20?s.formatDistance("lessThanXSeconds",20,n):h<40?s.formatDistance("halfAMinute",0,n):h<60?s.formatDistance("lessThanXMinutes",1,n):s.formatDistance("xMinutes",1,n):l===0?s.formatDistance("lessThanXMinutes",1,n):s.formatDistance("xMinutes",l,n);if(l<45)return s.formatDistance("xMinutes",l,n);if(l<90)return s.formatDistance("aboutXHours",1,n);if(l<$){const _=Math.round(l/60);return s.formatDistance("aboutXHours",_,n)}else{if(l<r)return s.formatDistance("xDays",1,n);if(l<y){const _=Math.round(l/$);return s.formatDistance("xDays",_,n)}else if(l<y*2)return x=Math.round(l/y),s.formatDistance("aboutXMonths",x,n)}if(x=te(d,m),x<12){const _=Math.round(l/y);return s.formatDistance("xMonths",_,n)}else{const _=x%12,S=Math.trunc(x/12);return _<3?s.formatDistance("aboutXYears",S,n):_<9?s.formatDistance("overXYears",S,n):s.formatDistance("almostXYears",S+1,n)}}function A(e,o){return oe(e,P(e),o)}const ae={class:"flex items-center justify-between p-6 border-b border-gray-200"},ne=["disabled"],re={class:"px-6 py-4 bg-gray-50 space-y-1"},ie={class:"text-sm text-gray-600"},le={class:"text-sm text-gray-600"},ce={class:"p-6"},de=["disabled"],ue={class:"text-right text-sm text-gray-500 mt-1"},fe={key:0,class:"mx-6 mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm"},me={class:"flex gap-3 p-6 border-t border-gray-200"},he=["disabled"],_e=["disabled"],N=500,pe=E({__name:"FeedbackModal",props:{completion:{}},emits:["close","feedback-added"],setup(e,{emit:o}){const t=e,i=o,s=I(),r=D(""),c=D(!1),n=D(null);T(()=>{t.completion.coach_feedback&&(r.value=t.completion.coach_feedback)});async function m(){if(!r.value.trim()){n.value="Feedback cannot be empty";return}c.value=!0,n.value=null;try{await U(t.completion.id,r.value.trim(),s.user.id),i("feedback-added")}catch(h){console.error("Error saving feedback:",h),n.value=h.message||"Failed to save feedback"}finally{c.value=!1}}function d(){c.value||i("close")}return(h,u)=>(g(),k("div",{class:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:d},[a("div",{class:"bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto",onClick:u[1]||(u[1]=Y(()=>{},["stop"]))},[a("div",ae,[u[3]||(u[3]=a("h2",{class:"text-xl font-bold text-gray-900"},"Provide Feedback",-1)),a("button",{onClick:d,class:"text-gray-400 hover:text-gray-600",disabled:c.value},[...u[2]||(u[2]=[a("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])],8,ne)]),a("div",re,[a("p",ie,[u[4]||(u[4]=a("span",{class:"font-semibold"},"Workout:",-1)),C(" "+f(e.completion.assignment?.workout?.name||"Workout"),1)]),a("p",le,[u[5]||(u[5]=a("span",{class:"font-semibold"},"Athlete:",-1)),C(" "+f(e.completion.athlete?.display_name||"Athlete"),1)])]),a("div",ce,[X(a("textarea",{"onUpdate:modelValue":u[0]||(u[0]=l=>r.value=l),maxlength:N,rows:"6",placeholder:"Great work today! Here's what I noticed...",class:"input resize-none",disabled:c.value},null,8,de),[[O,r.value]]),a("div",ue,f(r.value.length)+" / "+f(N),1)]),n.value?(g(),k("div",fe,f(n.value),1)):v("",!0),a("div",me,[a("button",{onClick:d,class:"btn-secondary flex-1",disabled:c.value}," Cancel ",8,he),a("button",{onClick:m,class:"btn-primary flex-1",disabled:c.value||!r.value.trim()},f(c.value?"Saving...":(e.completion.coach_feedback?"Update":"Save")+" Feedback"),9,_e)])])]))}}),ge={class:"card p-4 space-y-4"},xe={class:"flex items-start justify-between"},ke={class:"flex items-center gap-3"},ve=["src","alt"],be={class:"font-semibold text-gray-900"},we={class:"text-sm text-gray-600"},ye={class:"text-xs text-gray-500 whitespace-nowrap ml-2"},De={class:"flex gap-4 flex-wrap"},Me={key:0,class:"flex flex-col"},Se={class:"text-sm font-semibold text-gray-900"},Ce={class:"flex flex-col"},qe={class:"text-sm font-semibold text-gray-900"},Fe={key:1,class:"flex flex-col"},$e={class:"text-sm font-semibold text-peak-600"},Ae={key:2,class:"flex flex-col"},Ne={class:"text-sm font-semibold text-gray-900"},Ee={key:0,class:"bg-summit-50 rounded-xl p-3"},Ie={class:"flex items-start gap-2"},Te={class:"flex-1"},Xe={class:"text-sm text-gray-700"},Oe={key:0,class:"text-xs text-gray-500 mt-1"},Ye={class:"flex gap-2 pt-2 border-t border-gray-100"},Le=E({__name:"WorkoutCompletionCard",props:{completion:{}},emits:["feedback-added"],setup(e,{emit:o}){const t=e,i=o,s=D(!1),r=w(()=>t.completion.assignment?.workout?.name||"Workout"),c=w(()=>t.completion.athlete?.display_name||"Unknown Athlete"),n=w(()=>A(new Date(t.completion.completed_at),{addSuffix:!0})),m=w(()=>t.completion.exercise_results?.length||0),d=w(()=>t.completion.exercise_results?.filter(u=>u.is_pb).length||0);function h(){s.value=!1,i("feedback-added")}return(u,l)=>{const x=V("router-link");return g(),k("div",ge,[a("div",xe,[a("div",ke,[a("img",{src:e.completion.athlete?.avatar_url||"/default-avatar.png",alt:c.value,class:"avatar-md ring-2 ring-white shadow-sm"},null,8,ve),a("div",null,[a("h3",be,f(c.value),1),a("p",we,f(r.value),1)])]),a("span",ye,f(n.value),1)]),a("div",De,[e.completion.duration_minutes?(g(),k("div",Me,[l[2]||(l[2]=a("span",{class:"text-xs text-gray-500 uppercase"},"Duration",-1)),a("span",Se,f(e.completion.duration_minutes)+" min",1)])):v("",!0),a("div",Ce,[l[3]||(l[3]=a("span",{class:"text-xs text-gray-500 uppercase"},"Exercises",-1)),a("span",qe,f(m.value),1)]),d.value>0?(g(),k("div",Fe,[l[4]||(l[4]=a("span",{class:"text-xs text-gray-500 uppercase"},"PRs",-1)),a("span",$e,"ðŸ† "+f(d.value),1)])):v("",!0),e.completion.overall_rpe?(g(),k("div",Ae,[l[5]||(l[5]=a("span",{class:"text-xs text-gray-500 uppercase"},"RPE",-1)),a("span",Ne,f(e.completion.overall_rpe)+"/10",1)])):v("",!0)]),e.completion.coach_feedback?(g(),k("div",Ee,[a("div",Ie,[l[6]||(l[6]=a("span",{class:"text-summit-700 text-sm"},"ðŸ’¬",-1)),a("div",Te,[a("p",Xe,f(e.completion.coach_feedback),1),e.completion.feedback_at?(g(),k("p",Oe,f(z(A)(new Date(e.completion.feedback_at),{addSuffix:!0})),1)):v("",!0)])])])):v("",!0),a("div",Ye,[H(x,{to:`/coach/athletes/${e.completion.athlete_id}`,class:"btn-secondary btn-sm flex-1 text-center"},{default:W(()=>[...l[7]||(l[7]=[C(" View Details ",-1)])]),_:1},8,["to"]),a("button",{onClick:l[0]||(l[0]=_=>s.value=!0),class:"btn-primary btn-sm flex-1"},f(e.completion.coach_feedback?"Edit Feedback":"Add Feedback"),1)]),s.value?(g(),j(pe,{key:1,completion:e.completion,onClose:l[1]||(l[1]=_=>s.value=!1),onFeedbackAdded:h},null,8,["completion"])):v("",!0)])}}});export{Le as _,Be as a,je as b,Ve as c,A as f,We as g};
